Data Transformation with ‘dplyr’
================

*Aim: Get familiar with using the
[`dplyr`](https://dplyr.tidyverse.org/) package to wrangle dataframes.*

*Please see* ***[Data Transformation with dplyr cheat
sheets](https://rstudio.com/resources/cheatsheets/)*** *for a nice
overview of functions in this package.*

-----

Load in packages:

``` r
# install.packages("dplyr")
# install.packages("tibble")
library(dplyr)
library(tibble)
```

In order to use `dplyr` functions you need to ensure your dataframe is
in “tidy” format. This means in your dataframe each row represents an
observation and each column represents a variable. This is also called
“long format”.

We will use the `mtcars` dataset which is in tidy format to understand
dplyr functions.

``` r
head(mtcars)
```

    ##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb
    ## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
    ## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
    ## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
    ## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
    ## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
    ## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1

### Summarising data

<span style="color: darkblue;"> **How do I get summary of data?**
</span>

``` r
summary(mtcars)
```

    ##       mpg             cyl             disp             hp       
    ##  Min.   :10.40   Min.   :4.000   Min.   : 71.1   Min.   : 52.0  
    ##  1st Qu.:15.43   1st Qu.:4.000   1st Qu.:120.8   1st Qu.: 96.5  
    ##  Median :19.20   Median :6.000   Median :196.3   Median :123.0  
    ##  Mean   :20.09   Mean   :6.188   Mean   :230.7   Mean   :146.7  
    ##  3rd Qu.:22.80   3rd Qu.:8.000   3rd Qu.:326.0   3rd Qu.:180.0  
    ##  Max.   :33.90   Max.   :8.000   Max.   :472.0   Max.   :335.0  
    ##       drat             wt             qsec             vs        
    ##  Min.   :2.760   Min.   :1.513   Min.   :14.50   Min.   :0.0000  
    ##  1st Qu.:3.080   1st Qu.:2.581   1st Qu.:16.89   1st Qu.:0.0000  
    ##  Median :3.695   Median :3.325   Median :17.71   Median :0.0000  
    ##  Mean   :3.597   Mean   :3.217   Mean   :17.85   Mean   :0.4375  
    ##  3rd Qu.:3.920   3rd Qu.:3.610   3rd Qu.:18.90   3rd Qu.:1.0000  
    ##  Max.   :4.930   Max.   :5.424   Max.   :22.90   Max.   :1.0000  
    ##        am              gear            carb      
    ##  Min.   :0.0000   Min.   :3.000   Min.   :1.000  
    ##  1st Qu.:0.0000   1st Qu.:3.000   1st Qu.:2.000  
    ##  Median :0.0000   Median :4.000   Median :2.000  
    ##  Mean   :0.4062   Mean   :3.688   Mean   :2.812  
    ##  3rd Qu.:1.0000   3rd Qu.:4.000   3rd Qu.:4.000  
    ##  Max.   :1.0000   Max.   :5.000   Max.   :8.000

``` r
# Get mean of mpg
summarise(mtcars, avg=mean(mpg))
```

    ##        avg
    ## 1 20.09062

``` r
# What's the best way to get the mean for all columns?
```

<span style="color: darkblue;"> **How do I get summaries of grouped
variables?** </span>

``` r
grouped_mtcars <- mtcars %>%
                    group_by(cyl) %>%
                    summarise(avg=mean(mpg))
grouped_mtcars
```

    ## # A tibble: 3 x 2
    ##     cyl   avg
    ## * <dbl> <dbl>
    ## 1     4  26.7
    ## 2     6  19.7
    ## 3     8  15.1

Pipe operator `%>%` can be used to write tidy code. You can see that the
above, with pipes, is easier to read than the following, without pipes:

``` r
summarise(group_by(mtcars, cyl), avg = mean(mpg))
```

    ## # A tibble: 3 x 2
    ##     cyl   avg
    ## * <dbl> <dbl>
    ## 1     4  26.7
    ## 2     6  19.7
    ## 3     8  15.1

### Manipulating cases ie. rows

<span style="color: darkblue;"> **How do I subset rows based on a
logical criteria?** </span>

``` r
filter(mtcars, mpg > 25)
```

    ##                 mpg cyl  disp  hp drat    wt  qsec vs am gear carb
    ## Fiat 128       32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
    ## Honda Civic    30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
    ## Toyota Corolla 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
    ## Fiat X1-9      27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
    ## Porsche 914-2  26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
    ## Lotus Europa   30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2

<span style="color: darkblue;"> **How do I remove rows with duplicate
values?** </span>

``` r
# Return all unique items for "cyl" column
distinct(mtcars, cyl)
```

    ##                   cyl
    ## Mazda RX4           6
    ## Datsun 710          4
    ## Hornet Sportabout   8

``` r
# How do you keep the cases from the other columns?

# How can you ensure you're removing the correct duplicate cases? Presumbly it keeps the first unique case?
```

<span style="color: darkblue;"> **How do I select rows by position?**
</span>

``` r
mtcars %>%
  slice(10:15)
```

    ##                     mpg cyl  disp  hp drat   wt  qsec vs am gear carb
    ## Merc 280           19.2   6 167.6 123 3.92 3.44 18.30  1  0    4    4
    ## Merc 280C          17.8   6 167.6 123 3.92 3.44 18.90  1  0    4    4
    ## Merc 450SE         16.4   8 275.8 180 3.07 4.07 17.40  0  0    3    3
    ## Merc 450SL         17.3   8 275.8 180 3.07 3.73 17.60  0  0    3    3
    ## Merc 450SLC        15.2   8 275.8 180 3.07 3.78 18.00  0  0    3    3
    ## Cadillac Fleetwood 10.4   8 472.0 205 2.93 5.25 17.98  0  0    3    4

``` r
# last 5 rows:
mtcars %>% 
  slice((nrow(mtcars)-5):nrow(mtcars))
```

    ##                 mpg cyl  disp  hp drat    wt qsec vs am gear carb
    ## Porsche 914-2  26.0   4 120.3  91 4.43 2.140 16.7  0  1    5    2
    ## Lotus Europa   30.4   4  95.1 113 3.77 1.513 16.9  1  1    5    2
    ## Ford Pantera L 15.8   8 351.0 264 4.22 3.170 14.5  0  1    5    4
    ## Ferrari Dino   19.7   6 145.0 175 3.62 2.770 15.5  0  1    5    6
    ## Maserati Bora  15.0   8 301.0 335 3.54 3.570 14.6  0  1    5    8
    ## Volvo 142E     21.4   4 121.0 109 4.11 2.780 18.6  1  1    4    2

``` r
# Is there a neater way of doing that?
```

<span style="color: darkblue;"> **How do I select top n entries of a
variable and order them?** </span>

``` r
top_n(mtcars, 5, mpg) %>%
  arrange(desc(mpg))
```

    ##                 mpg cyl disp  hp drat    wt  qsec vs am gear carb
    ## Toyota Corolla 33.9   4 71.1  65 4.22 1.835 19.90  1  1    4    1
    ## Fiat 128       32.4   4 78.7  66 4.08 2.200 19.47  1  1    4    1
    ## Honda Civic    30.4   4 75.7  52 4.93 1.615 18.52  1  1    4    2
    ## Lotus Europa   30.4   4 95.1 113 3.77 1.513 16.90  1  1    5    2
    ## Fiat X1-9      27.3   4 79.0  66 4.08 1.935 18.90  1  1    4    1

### Manipulating variables ie. columns

<span style="color: darkblue;"> **How do I subset a dataframe by
columns?** </span>

``` r
select(mtcars, mpg, cyl) %>%
  head()
```

    ##                    mpg cyl
    ## Mazda RX4         21.0   6
    ## Mazda RX4 Wag     21.0   6
    ## Datsun 710        22.8   4
    ## Hornet 4 Drive    21.4   6
    ## Hornet Sportabout 18.7   8
    ## Valiant           18.1   6

``` r
# To exract columns as a vector:
pull(mtcars, mpg, cyl)
```

    ##    6    6    4    6    8    6    8    4    4    6    6    8    8    8    8    8 
    ## 21.0 21.0 22.8 21.4 18.7 18.1 14.3 24.4 22.8 19.2 17.8 16.4 17.3 15.2 10.4 10.4 
    ##    8    4    4    4    4    8    8    8    8    4    4    4    8    6    8    4 
    ## 14.7 32.4 30.4 33.9 21.5 15.5 15.2 13.3 19.2 27.3 26.0 30.4 15.8 19.7 15.0 21.4

<span style="color: darkblue;"> **Which function should I use if I want
to add a column to my dataframe?** </span>

``` r
mutate(mtcars, gpm = 1/mpg) %>%
  head()
```

    ##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb        gpm
    ## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 0.04761905
    ## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 0.04761905
    ## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 0.04385965
    ## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 0.04672897
    ## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 0.05347594
    ## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 0.05524862

``` r
# Can input any vector, as long as it's the same length as number of rows in your data frame. eg:
vector <- rep(1, nrow(mtcars))
mutate(mtcars, random_vec = vector) %>%
  head()
```

    ##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb random_vec
    ## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4          1
    ## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4          1
    ## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1          1
    ## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1          1
    ## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2          1
    ## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1          1

<span style="color: darkblue;"> **How do I create a new column but drop
the rest?** </span>

``` r
transmute(mtcars, gpm = 1/mpg) %>%
  head()
```

    ##                          gpm
    ## Mazda RX4         0.04761905
    ## Mazda RX4 Wag     0.04761905
    ## Datsun 710        0.04385965
    ## Hornet 4 Drive    0.04672897
    ## Hornet Sportabout 0.05347594
    ## Valiant           0.05524862

<span style="color: darkblue;"> **How do I apply a function to every
column?** </span>

``` r
mutate_all(mtcars, funs(.*100)) %>% # note the use of . in funs
  head()
```

    ## Warning: `funs()` is deprecated as of dplyr 0.8.0.
    ## Please use a list of either functions or lambdas: 
    ## 
    ##   # Simple named list: 
    ##   list(mean = mean, median = median)
    ## 
    ##   # Auto named with `tibble::lst()`: 
    ##   tibble::lst(mean, median)
    ## 
    ##   # Using lambdas
    ##   list(~ mean(., trim = .2), ~ median(., na.rm = TRUE))
    ## This warning is displayed once every 8 hours.
    ## Call `lifecycle::last_warnings()` to see where this warning was generated.

    ##                    mpg cyl  disp    hp drat    wt qsec  vs  am gear carb
    ## Mazda RX4         2100 600 16000 11000  390 262.0 1646   0 100  400  400
    ## Mazda RX4 Wag     2100 600 16000 11000  390 287.5 1702   0 100  400  400
    ## Datsun 710        2280 400 10800  9300  385 232.0 1861 100 100  400  100
    ## Hornet 4 Drive    2140 600 25800 11000  308 321.5 1944 100   0  300  100
    ## Hornet Sportabout 1870 800 36000 17500  315 344.0 1702   0   0  300  200
    ## Valiant           1810 600 22500 10500  276 346.0 2022 100   0  300  100

``` r
# What if not all our columns were numeric? We can do this:
mutate_if(mtcars, is.numeric, funs(.*100)) %>%
  head()
```

    ##                    mpg cyl  disp    hp drat    wt qsec  vs  am gear carb
    ## Mazda RX4         2100 600 16000 11000  390 262.0 1646   0 100  400  400
    ## Mazda RX4 Wag     2100 600 16000 11000  390 287.5 1702   0 100  400  400
    ## Datsun 710        2280 400 10800  9300  385 232.0 1861 100 100  400  100
    ## Hornet 4 Drive    2140 600 25800 11000  308 321.5 1944 100   0  300  100
    ## Hornet Sportabout 1870 800 36000 17500  315 344.0 1702   0   0  300  200
    ## Valiant           1810 600 22500 10500  276 346.0 2022 100   0  300  100

``` r
# What if you want to log transform a few variables for example.
# eg. log transform the mpg and cyl columns only:
mutate_at(mtcars, vars(c(mpg, cyl)) , funs(log(.))) %>%
  head
```

    ##                        mpg      cyl disp  hp drat    wt  qsec vs am gear carb
    ## Mazda RX4         3.044522 1.791759  160 110 3.90 2.620 16.46  0  1    4    4
    ## Mazda RX4 Wag     3.044522 1.791759  160 110 3.90 2.875 17.02  0  1    4    4
    ## Datsun 710        3.126761 1.386294  108  93 3.85 2.320 18.61  1  1    4    1
    ## Hornet 4 Drive    3.063391 1.791759  258 110 3.08 3.215 19.44  1  0    3    1
    ## Hornet Sportabout 2.928524 2.079442  360 175 3.15 3.440 17.02  0  0    3    2
    ## Valiant           2.895912 1.791759  225 105 2.76 3.460 20.22  1  0    3    1

<span style="color: darkblue;"> **How do I rename columns?** </span>

``` r
rename(mtcars, miles_per_gallon=mpg) %>%
  head()
```

    ##                   miles_per_gallon cyl disp  hp drat    wt  qsec vs am gear
    ## Mazda RX4                     21.0   6  160 110 3.90 2.620 16.46  0  1    4
    ## Mazda RX4 Wag                 21.0   6  160 110 3.90 2.875 17.02  0  1    4
    ## Datsun 710                    22.8   4  108  93 3.85 2.320 18.61  1  1    4
    ## Hornet 4 Drive                21.4   6  258 110 3.08 3.215 19.44  1  0    3
    ## Hornet Sportabout             18.7   8  360 175 3.15 3.440 17.02  0  0    3
    ## Valiant                       18.1   6  225 105 2.76 3.460 20.22  1  0    3
    ##                   carb
    ## Mazda RX4            4
    ## Mazda RX4 Wag        4
    ## Datsun 710           1
    ## Hornet 4 Drive       1
    ## Hornet Sportabout    2
    ## Valiant              1

``` r
# Be careful about names, avoid spaces. If you have have spaces use `` to enclose the variable name.
rename(mtcars, `miles per gallon`=mpg) %>%
  head()
```

    ##                   miles per gallon cyl disp  hp drat    wt  qsec vs am gear
    ## Mazda RX4                     21.0   6  160 110 3.90 2.620 16.46  0  1    4
    ## Mazda RX4 Wag                 21.0   6  160 110 3.90 2.875 17.02  0  1    4
    ## Datsun 710                    22.8   4  108  93 3.85 2.320 18.61  1  1    4
    ## Hornet 4 Drive                21.4   6  258 110 3.08 3.215 19.44  1  0    3
    ## Hornet Sportabout             18.7   8  360 175 3.15 3.440 17.02  0  0    3
    ## Valiant                       18.1   6  225 105 2.76 3.460 20.22  1  0    3
    ##                   carb
    ## Mazda RX4            4
    ## Mazda RX4 Wag        4
    ## Datsun 710           1
    ## Hornet 4 Drive       1
    ## Hornet Sportabout    2
    ## Valiant              1

### Row names

Be aware that if you have a variable stored as a row name then that you
want to work with then you need to move it to a collumn. The `tibble`
package has a function for this.

``` r
rownames_to_column(mtcars, var="Car") %>%
  head()
```

    ##                 Car  mpg cyl disp  hp drat    wt  qsec vs am gear carb
    ## 1         Mazda RX4 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
    ## 2     Mazda RX4 Wag 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
    ## 3        Datsun 710 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
    ## 4    Hornet 4 Drive 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
    ## 5 Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
    ## 6           Valiant 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1

### Combining Tables

`dply` also has functions for combining data frames:

``` r
# New dataframe:
df <- select(mtcars, new_mpg=mpg)
bind_cols(mtcars, df) %>% # BE SURE ROWS ALLIGN
  head()
```

    ##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb new_mpg
    ## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4    21.0
    ## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4    21.0
    ## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1    22.8
    ## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1    21.4
    ## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2    18.7
    ## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1    18.1

May be better to use a “mutating join” as that will match values with
the rows they correspond to. These include: `left_join`,`right_join`,
`inner_join` and `full_join`. Use the `by=` argument to specify the
column(s) both data frames match on or a named vector if the columns
have different names in each data frame.

Similarly, there are functions for rows. Such as `bind_rows`,
`intersect`, `setdiff`, `union`.
